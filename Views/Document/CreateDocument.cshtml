z@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "T·∫£i l√™n t√†i li·ªáu - Association Portal";
}

<div class="container mt-5">
    <h2 class="text-center text-primary mb-4">üìÑ T·∫£i l√™n t√†i li·ªáu m·ªõi</h2>

    <form id="createDocumentForm" class="card p-4 shadow-sm border-0 rounded-3" enctype="multipart/form-data">
        <div class="mb-3">
            <label class="form-label">Ti√™u ƒë·ªÅ t√†i li·ªáu</label>
            <input type="text" class="form-control" id="docTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ..." required />
        </div>

        <div class="mb-3">
            <label class="form-label">Danh m·ª•c</label>
            <select id="categorySelect" class="form-select" required>
                <option value="">-- Ch·ªçn danh m·ª•c --</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Ch·ªçn file</label>
            <input type="file" class="form-control" id="docFile" required />
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary w-100">
            <span id="btnText">T·∫£i l√™n</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
        </button>
    </form>

    <div id="resultMessage" class="mt-4"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("jwtToken");
    if (!token) {
        showMessage("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i l√™n t√†i li·ªáu!", "warning");
        setTimeout(() => window.location.href = "/auth/login", 1500);
        return;
    }

    // Load danh m·ª•c t·ª´ API
    try {
        const res = await fetch("/document/categories", {
            headers: { "Authorization": "Bearer " + token }
        });
        const categories = await res.json();
        const select = document.getElementById("categorySelect");
        categories.forEach(c => {
            select.innerHTML += `<option value="${c.categoryId}">${c.categoryName}</option>`;
        });
    } catch (err) {
        showMessage("Kh√¥ng th·ªÉ t·∫£i danh m·ª•c!", "danger");
    }

    const fileInput = document.getElementById("docFile");

    document.getElementById("createDocumentForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById("submitBtn");
        const btnText = document.getElementById("btnText");
        const btnSpinner = document.getElementById("btnSpinner");
        submitBtn.disabled = true;
        btnText.textContent = "ƒêang t·∫£i l√™n...";
        btnSpinner.classList.remove("d-none");

        const formData = new FormData();
        formData.append("title", document.getElementById("docTitle").value.trim());
        formData.append("categoryId", document.getElementById("categorySelect").value);
        formData.append("file", fileInput.files[0]);

        try {
            const res = await fetch("/document/upload", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token },
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                showMessage(data.message || "üéâ T·∫£i l√™n th√†nh c√¥ng! ƒêang ch·ªù duy·ªát.", "success");
                document.getElementById("createDocumentForm").reset();
            } else {
                showMessage(data.message || "L·ªói khi t·∫£i l√™n!", "danger");
            }
        } catch (err) {
            showMessage("L·ªói k·∫øt n·ªëi t·ªõi server!", "danger");
        } finally {
            submitBtn.disabled = false;
            btnText.textContent = "T·∫£i l√™n";
            btnSpinner.classList.add("d-none");
        }
    });

    function showMessage(message, type) {
        const msgDiv = document.getElementById("resultMessage");
        msgDiv.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(msgDiv.querySelector('.alert'));
            alert.close();
        }, 4000);
    }
});
</script>
