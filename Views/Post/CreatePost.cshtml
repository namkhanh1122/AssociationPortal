@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "ÄÄƒng bÃ i viáº¿t - Association Portal";
}

<div class="container mt-5">
    <h2 class="text-center text-primary mb-4">ğŸ“ ÄÄƒng bÃ i viáº¿t má»›i</h2>
    <form id="createPostForm">
        <div class="mb-3">
            <label class="form-label">TiÃªu Ä‘á» bÃ i viáº¿t</label>
            <input type="text" class="form-control" id="postTitle" required />
        </div>

        <div class="mb-3">
            <label class="form-label">Ná»™i dung bÃ i viáº¿t</label>
            <textarea class="form-control" id="postContent" rows="6" required></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">áº¢nh Ä‘áº¡i diá»‡n (URL)</label>
            <input type="text" class="form-control" id="thumbnailUrl" placeholder="/images/default.jpg" />
        </div>

        <div class="mb-3">
            <label class="form-label">Danh má»¥c</label>
            <select id="categorySelect" class="form-select"></select>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary w-100">
            <span id="btnText">ÄÄƒng bÃ i viáº¿t</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
    </form>

    <!-- ThÃ´ng bÃ¡o -->
    <div id="resultMessage" class="mt-4"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function () {
    try {
        const res = await fetch("/category/list");
        const categories = await res.json();

        const select = document.getElementById("categorySelect");
        select.innerHTML = `<option value="">ChÆ°a cÃ³ danh má»¥c</option>`;
        categories.forEach(c => {
            select.innerHTML += `<option value="${c.categoryId}">${c.categoryName}</option>`;
        });
    } catch (error) {
        showMessage(" Lá»—i khi táº£i danh má»¥c. Vui lÃ²ng thá»­ láº¡i!", "danger");
    }
});

document.getElementById("createPostForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const submitBtn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");

    // Hiá»‡u á»©ng loading
    submitBtn.disabled = true;
    btnText.textContent = "Äang Ä‘Äƒng...";
    btnSpinner.classList.remove("d-none");

    const data = {
        PostTitle: document.getElementById("postTitle").value,
        PostContent: document.getElementById("postContent").value,
        PostThumbnailUrl: document.getElementById("thumbnailUrl").value,
        CategoryId: document.getElementById("categorySelect").value || null,
        MemberId: 1 // táº¡m thá»i test, sau nÃ y sáº½ láº¥y tá»« session Ä‘Äƒng nháº­p
    };

    try {
        const response = await fetch("/post/createpost", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            showMessage(result.message || "ğŸ‰ BÃ i viáº¿t Ä‘Ã£ Ä‘Æ°á»£c gá»­i vÃ  Ä‘ang chá» duyá»‡t!", "success");
            document.getElementById("createPostForm").reset();
        } else {
            const err = await response.json();
            showMessage(err.message || " ÄÄƒng bÃ i tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i!", "danger");
        }
    } catch (error) {
        showMessage(" Lá»—i káº¿t ná»‘i Ä‘áº¿n server!", "danger");
    } finally {
        // Reset láº¡i nÃºt sau khi xá»­ lÃ½ xong
        submitBtn.disabled = false;
        btnText.textContent = "ÄÄƒng bÃ i viáº¿t";
        btnSpinner.classList.add("d-none");
    }
});

function showMessage(message, type) {
    const msgDiv = document.getElementById("resultMessage");
    msgDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    // áº¨n sau 5 giÃ¢y
    setTimeout(() => {
        const alert = bootstrap.Alert.getOrCreateInstance(msgDiv.querySelector('.alert'));
        alert.close();
    }, 5000);
}
</script>
