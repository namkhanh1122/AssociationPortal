@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "ÄÄƒng bÃ i viáº¿t - Association Portal";
}

<div class="container mt-5">
    <h2 class="text-center text-primary mb-4">ğŸ“ ÄÄƒng bÃ i viáº¿t má»›i</h2>

    <form id="createPostForm" class="card p-4 shadow-sm border-0 rounded-3">
        <div class="mb-3">
            <label class="form-label">TiÃªu Ä‘á» bÃ i viáº¿t</label>
            <input type="text" class="form-control" id="postTitle" placeholder="Nháº­p tiÃªu Ä‘á»..." required />
        </div>

        <div class="mb-3">
            <label class="form-label">Ná»™i dung bÃ i viáº¿t</label>
            <textarea class="form-control" id="postContent" rows="6" placeholder="Nháº­p ná»™i dung bÃ i viáº¿t..." required></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">áº¢nh Ä‘áº¡i diá»‡n (URL)</label>
            <input type="text" class="form-control" id="thumbnailUrl" placeholder="/images/default.jpg" />
        </div>

        <div class="mb-3">
            <label class="form-label">Danh má»¥c</label>
            <select id="categorySelect" class="form-select" required>
                <option value="">-- Chá»n danh má»¥c --</option>
            </select>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary w-100">
            <span id="btnText">ÄÄƒng bÃ i viáº¿t</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
        </button>
    </form>

    <div id="resultMessage" class="mt-4"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("jwtToken");

    // Náº¿u chÆ°a Ä‘Äƒng nháº­p â†’ cáº£nh bÃ¡o vÃ  chuyá»ƒn hÆ°á»›ng
    if (!token) {
        showMessage("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c khi Ä‘Äƒng bÃ i!", "warning");
        setTimeout(() => window.location.href = "/auth/login", 1500);
        return;
    }

    // Táº£i danh má»¥c
    try {
        const res = await fetch("/category/list");
        const categories = await res.json();

        const select = document.getElementById("categorySelect");
        select.innerHTML = `<option value="">-- Chá»n danh má»¥c --</option>`;
        categories.forEach(c => {
            select.innerHTML += `<option value="${c.categoryId}">${c.categoryName}</option>`;
        });
    } catch (err) {
        showMessage(" Lá»—i khi táº£i danh má»¥c!", "danger");
    }
});

// Xá»­ lÃ½ submit
document.getElementById("createPostForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("jwtToken");
    if (!token) {
        showMessage("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c khi Ä‘Äƒng bÃ i!", "warning");
        return;
    }

    const data = {
        PostTitle: document.getElementById("postTitle").value.trim(),
        PostContent: document.getElementById("postContent").value.trim(),
        PostThumbnailUrl: document.getElementById("thumbnailUrl").value.trim() || null,
        CategoryId: document.getElementById("categorySelect").value || null
    };

    const submitBtn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    submitBtn.disabled = true;
    btnText.textContent = "Äang Ä‘Äƒng...";
    btnSpinner.classList.remove("d-none");

    try {
        const res = await fetch("/post/createpost", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(data)
        });

        const result = await res.json();
        if (res.ok) {
            showMessage(result.message || "ğŸ‰ BÃ i viáº¿t Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng thÃ nh cÃ´ng!", "success");
            document.getElementById("createPostForm").reset();
        } else {
            showMessage(result.message || "âŒ Lá»—i khi Ä‘Äƒng bÃ i!", "danger");
        }
    } catch (err) {
        showMessage("ğŸš« Lá»—i káº¿t ná»‘i tá»›i server!", "danger");
    } finally {
        submitBtn.disabled = false;
        btnText.textContent = "ÄÄƒng bÃ i viáº¿t";
        btnSpinner.classList.add("d-none");
    }
});

// HÃ m hiá»ƒn thá»‹ thÃ´ng bÃ¡o
function showMessage(message, type) {
    const msgDiv = document.getElementById("resultMessage");
    msgDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => {
        const alert = bootstrap.Alert.getOrCreateInstance(msgDiv.querySelector('.alert'));
        alert.close();
    }, 4000);
}
</script>
